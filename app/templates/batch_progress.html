{% extends "base.html" %}

{% block title %}Batch Generation Progress - City Map Poster Generator{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div x-data="batchMonitor('{{ batch_id }}')" x-init="startPolling()">
        <!-- Progress Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">Batch Poster Generation</h1>
            <p class="text-gray-400" x-text="batchInfo.city + (batchInfo.country ? ', ' + batchInfo.country : '')"></p>
            <p class="text-sm text-gray-500 mt-1">
                Generating <span x-text="totalThemes"></span> poster<span x-show="totalThemes !== 1">s</span>
            </p>
        </div>
        
        <!-- Overall Progress Bar -->
        <div class="mb-8">
            <div class="flex justify-between text-sm text-gray-400 mb-2">
                <span>Overall Progress</span>
                <span x-text="completedCount + ' / ' + totalThemes + ' completed'"></span>
            </div>
            <div class="bg-slate-700 rounded-full h-6 overflow-hidden shadow-inner">
                <div 
                    class="h-full transition-all duration-500 ease-out flex items-center justify-end pr-2"
                    :class="allCompleted ? 'bg-green-600' : 'bg-blue-600'"
                    :style="`width: ${overallProgress}%`"
                >
                    <span class="text-white text-xs font-semibold" x-show="overallProgress > 5" x-text="`${overallProgress}%`"></span>
                </div>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-blue-400" x-text="totalThemes"></p>
                <p class="text-xs text-gray-400 mt-1">Total Themes</p>
            </div>
            <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-green-400" x-text="completedCount"></p>
                <p class="text-xs text-gray-400 mt-1">Completed</p>
            </div>
            <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-yellow-400" x-text="processingCount"></p>
                <p class="text-xs text-gray-400 mt-1">In Progress</p>
            </div>
            <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-red-400" x-text="failedCount"></p>
                <p class="text-xs text-gray-400 mt-1">Failed</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-center gap-4 mb-8" x-show="allCompleted">
            <a
                :href="`/api/v1/posters/batch/${batchInfo.batch_id}/download`"
                class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold flex items-center gap-2"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                Download All as ZIP
            </a>
            <a
                href="{{ url_for('web.gallery') }}"
                class="px-6 py-3 border border-slate-600 text-gray-300 rounded-lg hover:bg-slate-700 transition font-semibold"
            >
                View Gallery
            </a>
        </div>
        
        <!-- Individual Job Cards -->
        <div class="space-y-4">
            <template x-for="job in jobs" :key="job.job_id">
                <div 
                    class="batch-job-card"
                    :class="{
                        'completed': job.status === 'completed',
                        'failed': job.status === 'failed',
                        'processing': job.status === 'processing'
                    }"
                >
                    <div class="flex flex-col md:flex-row gap-4">
                        <!-- Thumbnail/Preview -->
                        <div class="flex-shrink-0">
                            <div class="w-full md:w-48 aspect-[3/4] bg-slate-700 rounded-lg overflow-hidden flex items-center justify-center">
                                <template x-if="job.status === 'completed' && job.result && job.result.poster_id">
                                    <img
                                        :src="`/api/v1/posters/${job.result.poster_id}/image`"
                                        :alt="`${job.theme} poster`"
                                        class="w-full h-full object-cover cursor-pointer batch-job-thumbnail"
                                        @click="window.location.href = `/posters/${job.result.poster_id}`"
                                    >
                                </template>
                                <template x-if="job.status === 'processing' || job.status === 'pending'">
                                    <div class="text-center p-4">
                                        <div class="spinner mx-auto mb-2"></div>
                                        <p class="text-gray-400 text-sm">Generating...</p>
                                    </div>
                                </template>
                                <template x-if="job.status === 'failed'">
                                    <div class="text-center p-4">
                                        <p class="text-red-400 text-4xl mb-2">‚ö†Ô∏è</p>
                                        <p class="text-red-400 text-sm">Failed</p>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Job Details -->
                        <div class="flex-grow">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="text-lg font-semibold text-white capitalize" x-text="job.theme.replace(/_/g, ' ')"></h3>
                                    <p class="text-sm text-gray-400" x-text="job.current_step || 'Waiting...'"></p>
                                </div>
                                <span 
                                    class="status-badge"
                                    :class="job.status"
                                    x-text="job.status"
                                ></span>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="batch-progress-bar">
                                <div
                                    class="batch-progress-fill"
                                    :style="`width: ${job.progress || 0}%`"
                                ></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1" x-text="`${job.progress || 0}% complete`"></p>
                            
                            <!-- Progress Steps History -->
                            <div x-show="job.progress_steps && job.progress_steps.length > 0" class="mt-3 space-y-1">
                                <template x-for="step in (job.progress_steps || []).slice(-3)" :key="step.timestamp">
                                    <div class="flex items-start gap-2 text-xs">
                                        <span
                                            class="flex-shrink-0 mt-0.5"
                                            :class="{
                                                'text-green-400': step.status === 'completed',
                                                'text-blue-400': step.status === 'in_progress',
                                                'text-gray-500': step.status === 'pending'
                                            }"
                                        >
                                            <template x-if="step.status === 'completed'">‚úì</template>
                                            <template x-if="step.status === 'in_progress'">‚ãØ</template>
                                            <template x-if="step.status === 'pending'">‚óã</template>
                                        </span>
                                        <span class="text-gray-400 flex-grow" x-text="step.step"></span>
                                    </div>
                                </template>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex gap-2 mt-4" x-show="job.status === 'completed' && job.result">
                                <a
                                    :href="`/posters/${job.result.poster_id}`"
                                    class="text-sm px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
                                >
                                    View Details
                                </a>
                                <a
                                    :href="`/api/v1/posters/${job.result.poster_id}/download`"
                                    class="text-sm px-4 py-2 border border-slate-600 text-gray-300 rounded hover:bg-slate-700 transition"
                                    download
                                >
                                    Download
                                </a>
                            </div>
                            
                            <!-- Error Message -->
                            <div x-show="job.status === 'failed' && job.error_message" class="mt-3">
                                <p class="text-sm text-red-400" x-text="job.error_message"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Loading State -->
        <div x-show="jobs.length === 0" class="text-center py-12">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-400">Loading batch information...</p>
        </div>

        <!-- All Failed State -->
        <div 
            x-show="jobs.length > 0 && failedCount === totalThemes"
            class="mt-8 bg-red-900/20 border border-red-700 rounded-lg p-6 text-center"
        >
            <p class="text-2xl mb-2">üòû</p>
            <h3 class="text-xl font-bold text-red-400 mb-2">All Generations Failed</h3>
            <p class="text-gray-400 mb-4">Unfortunately, all poster generations in this batch failed.</p>
            <a
                :href="`{{ url_for('web.create') }}?city=${encodeURIComponent(batchInfo.city)}&country=${encodeURIComponent(batchInfo.country)}&distance=${batchInfo.distance || 29000}`"
                class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold"
            >
                Try Again
            </a>
        </div>

        <!-- Success Message -->
        <div 
            x-show="allCompleted && failedCount === 0"
            class="mt-8 bg-green-900/20 border border-green-700 rounded-lg p-6 text-center"
        >
            <p class="text-4xl mb-2">üéâ</p>
            <h3 class="text-xl font-bold text-green-400 mb-2">Batch Complete!</h3>
            <p class="text-gray-400">All <span x-text="totalThemes"></span> posters have been generated successfully.</p>
        </div>
    </div>
</div>
{% endblock %}